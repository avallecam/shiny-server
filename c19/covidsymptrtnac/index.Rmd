---
title: "CDC Perú: Transmisión de COVID-19"
output: 
  flexdashboard::flex_dashboard:
    theme: cerulean
    orientation: columns
    vertical_layout: fill
    social: menu
    source_code: embed
runtime: shiny
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shinyWidgets)
library(plotly)
library(sf)
theme_set(theme_bw())

library(incidenceflow)
```

```{r}
# rute <- "data/rt_files/10-inc_rt_adm01.rds"
# # file.info(rute)
# # library(lubridate)
# date_input <- lubridate::date(file.info(rute)$mtime)
source("../run_shell.R")
# system("../updata.sh")
```

```{r}
# nivel adm01
ubigeo_diccionario_per2 <- 
  read_rds("data-raw/per4-shp_distritos_janitor.rds") %>% 
  as.data.frame() %>%
  select(starts_with("cd_"),starts_with("nm_"),-ends_with("_t")) %>% 
  mutate(nm_depa=if_else(nm_prov=="lima","lima_metropolitana",nm_depa)) %>%
  count(cd_depa,nm_depa) %>% 
  mutate(nm_pais="peru") %>% #avallecam::print_inf()
  as_tibble()

rute <- ""
ubigeo_geometria_per2 <- 
  sf::st_read(paste0(rute,"data-raw/shp/PER_adm1_avc.shp"),quiet=TRUE) %>% 
  mutate(nm_depa=janitor::make_clean_names(nm_depa)) %>% 
  mutate(nm_depa=if_else(nm_depa=="lima_provincia","lima",nm_depa)) %>% 
  mutate(nm_pais="peru") %>% 
  # preidentify stratification variables
  rename(strata_major=nm_pais,
         strata_minor=nm_depa)
```

INPUT {.sidebar}
===================================

Inputs {data-width=300}
-----------------------------------------------------------------------

__Actualización: `r date_input`__

__Fuente: Casos Sospechosos__

<!-- a -->

Nivel Departamental (1)
===================================

```{r}
adm00 <- read_rds("data/rt_files/101-inc_rt_adm00.rds")
adm01 <- read_rds("data/rt_files/101-inc_rt_adm01.rds")
strata_major_x <- "peru"
```


Column {.tabset}
-------------------------------------

### Mapa

<!-- ```{r} -->
<!-- rute <- "data/rt_files/rt-10-fig04.png" -->
<!-- img<-OpenImageR::readImage(rute) -->
<!-- OpenImageR::imageShow(img) -->
<!-- ``` -->

```{r}
# pais-departamento - map
g0 <- nested_figure_04(
  data = adm01,
  geometry = ubigeo_geometria_per2,
  strata_major = strata_major,
  strata_minor = strata_minor)

plotly::ggplotly(g0)
```


Column {.tabset}
-------------------------------------

### Rt Actual

<!-- ```{r} -->
<!-- rute <- "data/rt_files/rt-10-fig03.png" -->
<!-- img<-OpenImageR::readImage(rute) -->
<!-- OpenImageR::imageShow(img) -->
<!-- ``` -->

```{r}
# pais-departamento - dot
g2 <- adm01 %>% 
  # filtrar por area
  filter(strata_major == strata_major_x) %>% 
  # resumen
  mutate(sumx=map(
    .x = tsibble_day,
    .f = summarise,
    n_pos_clean=sum(n))) %>% 
  unnest(sumx) %>% 
  # extraer columna
  select(1:3,n_pos_clean,current_rt) %>% 
  # unnest(cols = c(current_rt)) %>% 
  nested_figure_03(strata_major = strata_major,
                   strata_minor = strata_minor,
                   strata_minor_code = strata_minor_code,
                   time_delay_days = 7)
plotly::ggplotly(g2)
```

<!-- a -->


Nivel Departamental (2)
===================================

```{r}
pickerInput('strata_minor','Departamento', 
            c("peru",sort(unique(ubigeo_diccionario_per2$nm_depa))),
            options = list(`actions-box` = TRUE),
            multiple = F, 
            selected = c("peru")
            # multiple = T, 
            # selected = c("amazonas","ica","ayacucho","callao")
            )
```


<!-- ```{r} -->
<!-- # solo departamento -->
<!-- # strata_minor_x <- input$strata_minor -->
<!-- strata_minor_x <- "amazonas" -->
<!-- ``` -->

Column {.tabset}
-------------------------------------
  
### Incidencia

```{r}
# pais-departamento - incid

renderPlotly({
  
g3 <- adm01 %>% 
  union_all(adm00) %>% 
  # filtrar por area
  filter(strata_major == strata_major_x) %>% 
  filter(strata_minor == input$strata_minor) %>% 
  # extraer solo una columna
  pull(tsibble_wik) %>% 
  pluck(1) %>% 
  # crear grafico
  ggplot(aes(x = date_incidence_case,y = n)) +
  geom_col() +
  # updates
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_x_date(date_breaks = "7 day",date_labels = "%b-%d") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = str_c("Incidencia: ",input$strata_minor),
       y = "Número de casos")
  
plotly::ggplotly(g3)
  
  
})


```


Column {.tabset}
-------------------------------------

### Rt en Tiempo

```{r}
# solo departamento - rt

renderPlotly({
  
  g1 <- adm01 %>% 
    union_all(adm00) %>% 
  # filtrar por area
  filter(strata_major == strata_major_x) %>% 
  filter(strata_minor == input$strata_minor) %>% 
  # extraer solo una columna
  pull(tsibble_rt) %>% 
  pluck(1) %>% 
  # crear grafico
  # incidenceflow
  figure_tsibble_rt() +
  # updates
  # scale_y_continuous(breaks = scales::pretty_breaks(n = 20)) +
  scale_x_date(date_breaks = "7 day",date_labels = "%b-%d") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = str_c("R efectivo: ",input$strata_minor),
       y = "Rt",color="",fill="")
  
plotly::ggplotly(g1)
  
})


# # https://stackoverflow.com/a/58145429/6702544
```

Nivel Departamental (3)
===================================
  
Column {.tabset}
-------------------------------------

### Tabla
  
```{r}
# pais-departamento - tabla
adm00 %>% 
  union_all(adm01) %>% 
  # filtrar por area
  filter(strata_major == strata_major_x) %>% 
  # extraer columna
  select(1:2,last5wk_rt) %>% 
  unnest(cols = c(last5wk_rt)) %>% 
  cdcper::cdc_datatable_html()
```

### Olas

<!-- ```{r} -->
<!-- # waves <- read_rds("data/rt_files/10-ola_dt_adm01.rds") %>% -->
<!-- #   select(-incidence_split_real,-cd_depa) -->
<!-- # wavesgg <- read_rds("data/rt_files/10-ola_gg_adm01.rds") -->
<!-- ``` -->


```{r}
read_rds("data/rt_files/10-ola_dt_adm01.rds") %>%
  select(-incidence_split_real,-cd_depa) %>%
  select(nm_depa,date_split,wave, everything()) %>%
  unnest(cols = c(strata_fit_tidy)) %>%
  select(-strata_fit_glance) %>%
  mutate(parameter=case_when(
    parameter=="r" ~ "growth_rate",
    TRUE ~ parameter
  )) %>%
    serosurvey::unite_dotwhiskers(variable_dot = estimate,
                                  variable_low = conf_lower,
                                  variable_upp = conf_upper,
                                  digits_dot = 1,
                                  digits_low = 1,
                                  digits_upp = 1,
                                  decimal_to_percent = FALSE) %>%
  select(-estimate,-conf_lower,-conf_upper,-unite2_estimate) %>%
  mutate(unite1_estimate=str_replace(unite1_estimate," \\(","["),
         unite1_estimate=str_replace(unite1_estimate,"\\)","]"),
         unite1_estimate=str_replace(unite1_estimate," - ",";"),
         unite1_estimate=str_replace_all(unite1_estimate," ","")) %>%
  rename(estimate=unite1_estimate) %>%
  cdcper::cdc_datatable_html()
```

<!-- ### Ajuste -->

<!-- ```{r} -->
<!-- # glance_incidence output -->
<!-- read_rds("data/rt_files/10-ola_dt_adm01.rds") %>% -->
<!--   select(-incidence_split_real,-cd_depa) %>% -->
<!--   select(nm_depa,date_split,wave, everything()) %>% -->
<!--   unnest(cols = c(strata_fit_glance)) %>% -->
<!--   select(-strata_fit_tidy,-(sigma:df.residual)) %>% -->
<!--   select(-r.squared) %>% -->
<!--   cdcper::cdc_datatable_html() -->

<!-- ``` -->

<!-- ### Curvas -->

<!-- ```{r} -->
<!-- waves_plot <- read_rds("data/rt_files/10-ola_gg_adm01.rds") %>% -->
<!--   ggplot() + -->
<!--   geom_point(aes(x = fecha_de_inicio_de_sintomas_corregido, -->
<!--              y = n, -->
<!--              color = wave), -->
<!--              size=0.5) + -->
<!--   geom_line(aes(x = fecha_de_inicio_de_sintomas_corregido, -->
<!--                 y = n_smooth), -->
<!--             size=0.3, -->
<!--             color="black") + -->
<!--   # geom_bar() + -->
<!--   facet_wrap(~nm_depa #,scales = "free_y" -->
<!--              ) + -->
<!--   theme_bw() -->

<!-- plotly::ggplotly(waves_plot) -->
<!-- ``` -->



Acerca
===================================

### Variación Temporal de la Transmisibilidad de Covid-19 en Perú a Nivel Nacional y Regional

#### Material y Métodos

Empleamos la base de datos de casos notificados diarios. Esta base es resultado 
de la unificación y limpieza de tres bases: 
(i) la base de pruebas serológicas o rápidas colectada por el aplicativo 
SISCOVID del Ministerio de Salud (Minsa), 
(ii) pruebas moleculares o reacción en cadena de polimerasas (PCR) colectada por 
el aplicativo NetLab del Instituto Nacional de Salud (INS) y 
(iii) notificación de casos por el aplicativo NotiSp del Centro Nacional de 
Epidemiología (CDC). 
<!-- Las variables de ubicación geográfica y fecha de inicio de síntomas fueron  -->
<!-- unificadas priorizando las fuentes de información con mayor control de calidad  -->
<!-- y validación por persona. -->

Conservamos los casos sin antecedentes de viaje o contacto (por transmisión local) 
y sintomáticos. Calculamos una serie de tiempo de casos incidentes por día según 
el autoreporte de inicio de síntomas. En las observaciones con valor perdido en 
la fecha de inicio de síntomas, ejecutamos una imputación según la mediana de 
días de retraso entre la fecha de inicio de síntomas y fecha de confirmación del 
caso, estratificada por departamento.

Para la estimación de la variación temporal del número reproductivo efectivo (Rt) 
usamos el paquete estadístico EpiEstim (1). El método de estimación del Rt a partir 
de la curva de casos incidentes y la distribución del intervalo serial está detallado 
en Cori et al. 2013 (2) basado en Wallinga et al. 2004 (3). En breve, el Rt está 
definido como la razón entre el número de nuevos casos infectados locales en el 
tiempo t y el total de las posibles infecciones por todos los individuos infectados 
en el tiempo t. Con esto, la incidencia de casos en el tiempo t, en promedio, 
está definida por $E[I_t]=R_t∑_{t , s=1}I_{t-s}w_s$ , donde $E[X]$ denota el 
valor esperado aleatorio de $X$ , $s$ es el tiempo de ventana de 
estimación, $I_{t-s}$ la incidencia observada en el tiempo $t-s$ , y $w_s$ la 
infectividad por individuo dependiente de la distribución del intervalo serial 
o tiempo entre la infección del caso infector y el caso infectado. Mediante 
inferencia bayesiana, se estima el Rt como un promedio de la distribución 
posterior e intervalos de credibilidad al 95%. Aquí empleamos una ventana de 
estimación de 7 días, asumimos un intervalo serial paramétrico de 3.96 ± 4.75 días (4) 
y un número reproductivo básico constante durante el tiempo de la ventana de estimación.

Empleamos el software de programación estadística R para la limpieza, manejo y 
ejecución de las estimaciones.

#### Referencias

1. Anne Cori (2019). EpiEstim: Estimate Time Varying Reproduction Numbers from Epidemic Curves. R package version 2.2-1. https://CRAN.R-project.org/package=EpiEstim
2. Cori, A., Ferguson, N. M., Fraser, C., & Cauchemez, S. (2013). A new framework and software to estimate time-varying reproduction numbers during epidemics. American journal of epidemiology, 178(9), 1505-1512. https://academic.oup.com/aje/article/178/9/1505/89262
3. Wallinga, J., & Teunis, P. (2004). Different epidemic curves for severe acute respiratory syndrome reveal similar impacts of control measures. American Journal of epidemiology, 160(6), 509-516. https://academic.oup.com/aje/article/160/6/509/79472
4. Du, Z., Xu, X., Wu, Y., Wang, L., Cowling, B. J., & Meyers, L. (2020). Serial Interval of COVID-19 among Publicly Reported Confirmed Cases. Emerging Infectious Diseases, 26(6), 1341-1343. https://dx.doi.org/10.3201/eid2606.200357.

#### Equipo

**Información:** Noti / CDC MINSA - Reporte de Pruebas rapidas, SIS-COVID/ OGTI - reporte Netlab Pruebas moleculares / INS.

**Análisis:** CDC MINSA
